#!/usr/bin/env bash
set -e

# =============================================================================
# Daybreak Health Backend - Local Development Startup Script
# =============================================================================
# This script starts all local services needed for frontend testing.
#
# Usage:
#   bin/start-local           # Start all services
#   bin/start-local --clean   # Clean start (removes volumes)
#   bin/start-local --stop    # Stop all services
#   bin/start-local --status  # Show service status
# =============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
COMPOSE_FILE="$PROJECT_DIR/docker/docker-compose.dev.yml"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print colored output
print_header() {
    echo -e "\n${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}\n"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}⚠${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1"
}

print_info() {
    echo -e "${BLUE}ℹ${NC} $1"
}

# Check if Docker is installed and running
check_docker() {
    print_header "Checking Prerequisites"

    if ! command -v docker &> /dev/null; then
        print_error "Docker is not installed. Please install Docker Desktop."
        exit 1
    fi
    print_success "Docker is installed"

    if ! docker info &> /dev/null; then
        print_error "Docker is not running. Please start Docker Desktop."
        exit 1
    fi
    print_success "Docker is running"

    if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
        print_error "Docker Compose is not available."
        exit 1
    fi
    print_success "Docker Compose is available"
}

# Check and setup .env file
setup_env() {
    print_header "Environment Setup"

    if [ ! -f "$PROJECT_DIR/.env" ]; then
        print_warning ".env file not found. Creating from .env.example..."
        cp "$PROJECT_DIR/.env.example" "$PROJECT_DIR/.env"
        print_success "Created .env file from .env.example"
        print_warning "You may need to update .env with your actual API keys"
    else
        print_success ".env file exists"
    fi
}

# Stop all services
stop_services() {
    print_header "Stopping Services"
    docker-compose -f "$COMPOSE_FILE" down --remove-orphans
    print_success "All services stopped"
}

# Clean start (remove volumes)
clean_start() {
    print_header "Cleaning Up"
    docker-compose -f "$COMPOSE_FILE" down -v --remove-orphans
    print_success "Removed containers and volumes"
}

# Show service status
show_status() {
    print_header "Service Status"
    docker-compose -f "$COMPOSE_FILE" ps
}

# Wait for a service to be healthy
wait_for_service() {
    local service=$1
    local max_attempts=${2:-30}
    local attempt=1

    echo -n "  Waiting for $service"
    while [ $attempt -le $max_attempts ]; do
        if docker-compose -f "$COMPOSE_FILE" ps "$service" 2>/dev/null | grep -q "healthy\|running"; then
            echo -e " ${GREEN}ready${NC}"
            return 0
        fi
        echo -n "."
        sleep 2
        ((attempt++))
    done
    echo -e " ${RED}timeout${NC}"
    return 1
}

# Start all services
start_services() {
    print_header "Starting Services"

    print_info "Starting Docker containers..."
    docker-compose -f "$COMPOSE_FILE" up -d

    echo ""
    print_info "Waiting for services to be ready..."

    # Wait for DB and Redis first
    wait_for_service "db" 30
    wait_for_service "redis" 30

    # Web and Sidekiq take longer due to bundle install
    print_info "Web service is installing dependencies (this may take a few minutes on first run)..."
    wait_for_service "web" 120

    print_info "Waiting for Sidekiq..."
    wait_for_service "sidekiq" 120
}

# Print service endpoints
print_endpoints() {
    print_header "Services Ready!"

    echo -e "  ${GREEN}Backend API:${NC}        http://localhost:3000"
    echo -e "  ${GREEN}GraphQL Playground:${NC} http://localhost:3000/graphql"
    echo -e "  ${GREEN}PostgreSQL:${NC}         localhost:5432"
    echo -e "  ${GREEN}Redis:${NC}              localhost:6379"
    echo ""
    echo -e "  ${BLUE}Frontend should connect to:${NC} http://localhost:3000"
    echo ""
    print_header "Useful Commands"
    echo "  View logs:          bin/docker logs"
    echo "  Rails console:      bin/docker console"
    echo "  Shell access:       bin/docker bash"
    echo "  Stop services:      bin/start-local --stop"
    echo "  Service status:     bin/start-local --status"
    echo ""
}

# Main execution
cd "$PROJECT_DIR"

case "${1:-start}" in
    --stop|-s)
        stop_services
        ;;
    --clean|-c)
        clean_start
        check_docker
        setup_env
        start_services
        print_endpoints
        ;;
    --status)
        show_status
        ;;
    --help|-h)
        echo "Usage: bin/start-local [option]"
        echo ""
        echo "Options:"
        echo "  (default)    Start all services"
        echo "  --stop, -s   Stop all services"
        echo "  --clean, -c  Clean start (removes volumes, fresh database)"
        echo "  --status     Show service status"
        echo "  --help, -h   Show this help"
        ;;
    *)
        check_docker
        setup_env
        start_services
        print_endpoints
        ;;
esac
