<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>2</storyId>
    <title>Insurance Cost Estimation</title>
    <status>drafted</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/epics.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>parent with verified insurance</asA>
    <iWant>to see estimated costs based on my coverage</iWant>
    <soThat>I know what I'll pay out of pocket</soThat>
    <tasks>
- Task 1: Create InsuranceEstimateService (AC: 1, 2, 3, 4, 5)
  - Create app/services/billing/insurance_estimate_service.rb
  - Accept insurance record as input parameter
  - Validate insurance is verified (eligibility_verified?)
  - Retrieve coverage details from verification_result JSONB
  - Extract copay, coinsurance, deductible amounts
  - Extract deductible_met amount
  - Implement calculate_patient_responsibility method
  - Add RSpec unit tests for service

- Task 2: Implement Cost Calculation Logic (AC: 2)
  - Load base session rate from contracts.csv (individual_therapy, family_therapy)
  - Determine allowed amount based on plan type and network status
  - Calculate patient responsibility based on deductible status:
    - If deductible not met: patient pays full allowed amount (up to deductible remaining)
    - If deductible met and copay exists: patient pays copay amount
    - If deductible met and coinsurance exists: patient pays coinsurance % of allowed amount
  - Return estimate hash with breakdown components
  - Add unit tests for calculation scenarios

- Task 3: Handle Plan Type Variations (AC: 2)
  - Implement HMO plan logic (typically copay-based)
  - Implement PPO plan logic (typically coinsurance after deductible)
  - Implement high-deductible plan logic (patient pays until deductible met)
  - Use plan_type from verification_result if available
  - Fallback to deductible/copay presence to infer plan type
  - Add tests for each plan type scenario

- Task 4: Add Estimate Caching (AC: 6)
  - Cache estimate results with eligibility data in Redis
  - Use cache key: "insurance:estimate:#{insurance.id}:#{verified_at_timestamp}"
  - Set TTL to 24 hours (matches eligibility cache)
  - Invalidate cache when verification_result changes
  - Add tests for cache hit/miss scenarios

- Task 5: Create Estimate GraphQL Query (AC: 1, 3, 4, 5)
  - Create app/graphql/types/cost_estimate_type.rb
  - Define fields: insurancePays, patientPays, allowedAmount, billedAmount, deductibleStatus
  - Define field: coverageLimitations (array of strings)
  - Create app/graphql/queries/insurance_cost_estimate.rb
  - Accept argument: sessionId (ID, required)
  - Find insurance for session
  - Validate insurance is verified
  - Call InsuranceEstimateService
  - Return CostEstimateType with disclaimer
  - Add query to QueryType registry
  - Create query integration tests

- Task 6: Add Coverage Limitation Detection (AC: 5)
  - Parse verification_result for session limits
  - Parse verification_result for prior authorization requirements
  - Parse verification_result for network restrictions
  - Return limitations as user-friendly strings
  - Add tests for limitation scenarios

- Task 7: Format Estimate with Disclaimer (AC: 6)
  - Add isEstimate boolean flag (always true)
  - Add disclaimer text constant
  - Include "not a guarantee" messaging
  - Format amounts as currency strings
  - Add deductible status indicator (met/not met/remaining)
  - Add tests for formatting

- Task 8: Update InsuranceType with Estimate Field (AC: 1)
  - Add costEstimate field to app/graphql/types/insurance_type.rb
  - Return null if not verified
  - Call InsuranceEstimateService when field resolved
  - Add field resolver tests

- Task 9: Integration with Test Data (AC: all)
  - Load test scenarios from docs/test-cases/insurance_coverages.csv
  - Create test cases for various coverage scenarios
  - Verify estimates against expected patient responsibility
  - Test with docs/test-cases/credentialed_insurances.csv for network data
  - Add integration tests using CSV test data

- Task 10: Add Audit Logging (AC: all)
  - Log COST_ESTIMATE_REQUESTED action
  - Include insurance_id and session_id in details
  - Never log actual coverage amounts (PHI-safe)
  - Log only that estimate was calculated
    </tasks>
  </story>

  <acceptanceCriteria>
1. Given insurance is verified (from Epic 4), When cost estimate is requested, Then system retrieves coverage details: copay, coinsurance, deductible

2. Given coverage details retrieved, When calculating estimated patient responsibility, Then system calculates: If deductible not met: full allowed amount until met; After deductible: copay or coinsurance applies

3. Given estimate is calculated, When displaying to parent, Then system shows: insurance pays, patient pays, deductible status

4. Given allowed amount is available, When displaying cost, Then system displays allowed amount vs. billed amount

5. Given coverage has limitations, When estimate is shown, Then system explains any coverage limitations (session limits, prior auth)

6. Given estimate is displayed, When parent views cost, Then estimate is clearly marked as estimate (not guarantee) and updated when eligibility data changes
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Epic 6: Cost Estimation Tool</section>
        <snippet>Story 6.2 provides parents with transparent cost information including insurance estimates, self-pay rates, deductible tracking, and payment options. This reduces surprise bills and increases trust.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 6: Cost Estimation Tool - Story 6.2</section>
        <snippet>Story 6.2 calculates estimated costs based on insurance coverage including copay, coinsurance, deductible status, and coverage limitations. InsuranceEstimateService uses eligibility data to handle various plan types: HMO, PPO, high-deductible. Cache estimates with eligibility data. Test data: insurance_coverages.csv for coverage details, credentialed_insurances.csv for payer/network information.</snippet>
      </doc>
      <doc>
        <path>docs/test-cases/insurance_coverages.csv</path>
        <title>Insurance Coverage Test Data</title>
        <section>Coverage scenarios with copay, coinsurance, deductible</section>
        <snippet>Contains real-world insurance coverage scenarios including member_id, group_id, plan_holder info, eligibility status, coverage amounts. Use for testing cost estimation calculations with various plan types.</snippet>
      </doc>
      <doc>
        <path>docs/test-cases/credentialed_insurances.csv</path>
        <title>Credentialed Insurance Payers</title>
        <section>Payer/network information</section>
        <snippet>Contains insurance payer definitions with name, state, line_of_business, network_status. Use for determining in-network vs out-of-network status when calculating allowed amounts.</snippet>
      </doc>
      <doc>
        <path>docs/test-cases/contracts.csv</path>
        <title>Service Pricing Terms</title>
        <section>Pricing for individual_therapy, family_therapy, etc.</section>
        <snippet>Contains service pricing terms with effective dates, services covered (individual_therapy, family_therapy, onsite_care), and contract terms including caps and collection rules. Use for base rate calculations.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>app/models/insurance.rb</path>
        <kind>model</kind>
        <symbol>Insurance</symbol>
        <lines>1-430</lines>
        <reason>Insurance model with verification_result JSONB field containing coverage details (copay_amount, deductible_amount, deductible_met, coinsurance_percentage). Has helper methods: eligible?, mental_health_covered?, copay_amount, deductible_amount, deductible_met, coinsurance_percentage. Required for InsuranceEstimateService to extract coverage data.</reason>
      </artifact>
      <artifact>
        <path>app/services/eligibility/edi_adapter.rb</path>
        <kind>service</kind>
        <symbol>Eligibility::EdiAdapter</symbol>
        <lines>1-686</lines>
        <reason>Eligibility verification adapter that populates verification_result with coverage data. Shows structure of verification_result JSONB (eligible, coverage hash with copay, deductible, coinsurance, effective_date). Reference for understanding coverage data format.</reason>
      </artifact>
      <artifact>
        <path>app/services/insurance_services/coverage_formatter.rb</path>
        <kind>service</kind>
        <symbol>InsuranceServices::CoverageFormatter</symbol>
        <lines>1-168</lines>
        <reason>Existing service that formats coverage details for display. Shows pattern for accessing coverage from verification_result. Has methods: format_copay, format_deductible, format_coinsurance. Can be used as reference or extended for cost estimation formatting.</reason>
      </artifact>
    </code>
    <dependencies>
      <ruby>
        <version>3.3.x</version>
        <gem name="rails" version="~> 7.2.3">Rails 7 API framework</gem>
        <gem name="graphql" version="~> 2.2">GraphQL server for queries</gem>
        <gem name="redis" version="~> 5.0">Redis for estimate caching</gem>
        <gem name="rspec-rails" version="~> 6.1">Testing framework</gem>
        <gem name="factory_bot_rails" version="~> 6.4">Test fixtures</gem>
      </ruby>
      <test_data>
        <required>
          <file path="docs/test-cases/insurance_coverages.csv">Coverage scenarios with copay, coinsurance, deductible amounts for testing</file>
          <file path="docs/test-cases/credentialed_insurances.csv">Payer/network information for in-network calculations</file>
          <file path="docs/test-cases/contracts.csv">Service pricing terms for base rate calculations</file>
        </required>
      </test_data>
      <environment>
        <var name="REDIS_URL">Redis connection for estimate caching</var>
        <var name="BASE_THERAPY_RATE">Base rate for therapy sessions (fallback if contracts.csv not available)</var>
      </environment>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Insurance Verified: Cost estimates can ONLY be calculated for verified insurance (verification_status == verified)</constraint>
    <constraint>Estimate Disclaimer: ALL cost estimates MUST be clearly marked as estimates, not guarantees</constraint>
    <constraint>Deductible Logic: Patient responsibility MUST accurately reflect deductible status (not met = patient pays until met; met = copay/coinsurance applies)</constraint>
    <constraint>Plan Type Handling: Service MUST handle HMO (copay-based), PPO (coinsurance after deductible), and high-deductible plans differently</constraint>
    <constraint>Cache Consistency: Estimate cache MUST be invalidated when verification_result changes or is older than 24 hours</constraint>
    <constraint>PHI-Safe Logging: Audit logs MUST NOT log actual coverage amounts, only that estimate was calculated</constraint>
    <constraint>Coverage Limitations: Service MUST detect and communicate session limits, prior auth requirements, network restrictions from verification_result</constraint>
    <constraint>Allowed vs Billed: When available, MUST display allowed amount (contracted rate) vs billed amount for transparency</constraint>
    <constraint>Test Data Integration: MUST use CSV test data files for integration testing to ensure realistic scenarios</constraint>
    <constraint>Error Handling: MUST return clear errors if insurance not verified, verification_result missing, or coverage data incomplete</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Billing::InsuranceEstimateService#calculate</name>
      <kind>service_method</kind>
      <signature>calculate(insurance:, service_type: 'individual_therapy') -> Hash</signature>
      <path>app/services/billing/insurance_estimate_service.rb</path>
      <description>Calculates cost estimate for therapy session based on insurance coverage. Returns hash with: insurance_pays, patient_pays, allowed_amount, billed_amount, deductible_status, coverage_limitations, is_estimate (always true), disclaimer.</description>
    </interface>
    <interface>
      <name>Queries::InsuranceCostEstimate</name>
      <kind>graphql_query</kind>
      <signature>insuranceCostEstimate(sessionId: ID!): CostEstimate</signature>
      <path>app/graphql/queries/insurance_cost_estimate.rb</path>
      <description>GraphQL query to retrieve cost estimate for a session's insurance. Returns CostEstimateType with breakdown of costs and disclaimer.</description>
    </interface>
    <interface>
      <name>Types::CostEstimateType</name>
      <kind>graphql_type</kind>
      <signature>insurancePays: Float, patientPays: Float, allowedAmount: Float, billedAmount: Float, deductibleStatus: DeductibleStatusType, coverageLimitations: [String!], isEstimate: Boolean!, disclaimer: String!</signature>
      <path>app/graphql/types/cost_estimate_type.rb</path>
      <description>GraphQL type definition for cost estimate. Exposes breakdown of insurance responsibility, patient responsibility, deductible status, and any coverage limitations.</description>
    </interface>
    <interface>
      <name>Types::DeductibleStatusType</name>
      <kind>graphql_type</kind>
      <signature>amount: Float, met: Float, remaining: Float, isMet: Boolean!</signature>
      <path>app/graphql/types/deductible_status_type.rb</path>
      <description>GraphQL type for deductible status showing total amount, amount met, remaining, and boolean flag for fully met.</description>
    </interface>
    <interface>
      <name>InsuranceType#costEstimate</name>
      <kind>graphql_field</kind>
      <signature>costEstimate(serviceType: String): CostEstimate</signature>
      <path>app/graphql/types/insurance_type.rb</path>
      <description>Field on InsuranceType that resolves cost estimate for this insurance. Returns null if not verified. Accepts optional serviceType argument (defaults to 'individual_therapy').</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Rails project uses RSpec for testing with Factory Bot for fixtures and Shoulda Matchers for model testing. Test structure follows Rails conventions with spec/services/, spec/graphql/, and spec/integration/ directories. Cost estimation logic requires extensive test coverage for various plan types (HMO, PPO, high-deductible), deductible scenarios (not met, partially met, fully met), and coverage limitations. Integration tests MUST use CSV test data files (insurance_coverages.csv, credentialed_insurances.csv, contracts.csv) for realistic scenarios. Cache behavior MUST be tested (cache hit, cache miss, invalidation). Test coverage target: 90%+ for all new code.
    </standards>
    <locations>
      <location>spec/services/billing/insurance_estimate_service_spec.rb</location>
      <location>spec/graphql/queries/insurance_cost_estimate_spec.rb</location>
      <location>spec/graphql/types/cost_estimate_type_spec.rb</location>
      <location>spec/graphql/types/deductible_status_type_spec.rb</location>
      <location>spec/integration/insurance_cost_estimation_spec.rb</location>
    </locations>
    <ideas>
      <idea acceptance_criteria="AC1">Test calculate method retrieves coverage details: copay, coinsurance, deductible from verified insurance</idea>
      <idea acceptance_criteria="AC2">Test patient responsibility when deductible not met: patient pays full allowed amount (up to deductible remaining)</idea>
      <idea acceptance_criteria="AC2">Test patient responsibility when deductible met with copay: patient pays copay amount</idea>
      <idea acceptance_criteria="AC2">Test patient responsibility when deductible met with coinsurance: patient pays coinsurance % of allowed amount</idea>
      <idea acceptance_criteria="AC3">Test estimate includes insurance_pays, patient_pays, and deductible_status fields</idea>
      <idea acceptance_criteria="AC4">Test allowed_amount vs billed_amount displayed when available</idea>
      <idea acceptance_criteria="AC5">Test coverage limitations detected: session limits, prior auth requirements, network restrictions</idea>
      <idea acceptance_criteria="AC6">Test estimate marked as is_estimate: true with disclaimer</idea>
      <idea acceptance_criteria="AC6">Test estimate cache invalidated when verification_result changes</idea>
      <idea>Test HMO plan type: copay-based calculation</idea>
      <idea>Test PPO plan type: coinsurance after deductible calculation</idea>
      <idea>Test high-deductible plan: patient pays until deductible met</idea>
      <idea>Test cache hit scenario: second estimate request returns cached result</idea>
      <idea>Test cache miss scenario: first estimate request calculates and caches result</idea>
      <idea>Test cache expiry: estimates older than 24 hours are recalculated</idea>
      <idea>Test error when insurance not verified: returns clear error message</idea>
      <idea>Test error when verification_result missing coverage data: returns error</idea>
      <idea>Integration test: load insurance_coverages.csv and calculate estimates for all scenarios</idea>
      <idea>Integration test: verify network status from credentialed_insurances.csv affects allowed amount</idea>
      <idea>Integration test: load base rates from contracts.csv for calculation</idea>
      <idea>Test audit logging: COST_ESTIMATE_REQUESTED logged without coverage amounts</idea>
      <idea>Test deductible partially met scenario: patient pays remaining deductible amount</idea>
      <idea>Test combined copay and coinsurance: use copay if both exist</idea>
      <idea>Test family vs individual deductible: track separately when specified</idea>
    </ideas>
  </tests>
</story-context>
