<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>6</epicId>
    <storyId>1</storyId>
    <title>Cost Calculation Engine</title>
    <status>drafted</status>
    <generatedAt>2025-11-30</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/epics.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system</asA>
    <iWant>a flexible engine to calculate therapy session costs</iWant>
    <soThat>costs can be computed based on various factors</soThat>
    <tasks>
- Task 1: Create SessionRate Model for Configurable Rates (AC: 1, 4, 5)
  - Run migration to create session_rates table
  - Create app/models/session_rate.rb with Active Record model
  - Add fields: service_type (enum), base_rate (decimal), effective_date, end_date
  - Add validations for rate fields and date ranges
  - Create factory for testing with realistic rates
  - Add RSpec model tests for validations and scopes

- Task 2: Create CostCalculationService (AC: 1, 2, 3)
  - Create app/services/billing/cost_calculation_service.rb inheriting from BaseService
  - Implement calculate method accepting session_type, duration, modifiers, discounts
  - Query SessionRate model for current base rate by service type
  - Apply duration modifiers (prorated by minutes)
  - Apply therapist tier modifiers if applicable
  - Apply tax calculations based on jurisdiction
  - Apply discount codes or hardship adjustments
  - Return structured breakdown with gross cost, adjustments array, net cost
  - Add unit tests for all calculation scenarios

- Task 3: Add Calculation Breakdown Storage (AC: 3, 5)
  - Extend OnboardingSession or create CostEstimate model to store calculation_breakdown JSON
  - Store breakdown with timestamp, inputs, gross_cost, line_items, net_cost
  - Ensure breakdown is auditable and immutable once created
  - Add helper methods to retrieve and display breakdowns
  - Add RSpec tests for breakdown storage and retrieval

- Task 4: Seed Service Pricing from contracts.csv (AC: 1, 4)
  - Create db/seeds/service_rates.rb to parse docs/test-cases/contracts.csv
  - Extract service types from "services" JSON array (individual_therapy, family_therapy, etc.)
  - Map contract terms to session rates (parse "terms" JSON for pricing data)
  - Seed SessionRate records with effective_date and end_date from CSV
  - Document pricing structure in code comments
  - Test seed task runs successfully

- Task 5: Create GraphQL Types for Cost Display (AC: 3, 5)
  - Create app/graphql/types/cost_breakdown_type.rb
  - Define fields: grossCost, netCost, adjustments, calculatedAt
  - Create app/graphql/types/cost_adjustment_type.rb for line items
  - Define fields: type, description, amount, percentage
  - Add costEstimate field to OnboardingSessionType
  - Add tests for GraphQL type definitions

- Task 6: Implement Cost Calculation Query (AC: 1, 2, 3)
  - Create app/graphql/queries/calculate_cost.rb
  - Accept arguments: serviceType, duration, therapistId (optional), discountCode (optional)
  - Call CostCalculationService with provided parameters
  - Return CostBreakdownType with full calculation details
  - Add authorization check (session ownership or admin)
  - Add integration tests for cost calculation flow

- Task 7: Add Audit Logging for Cost Calculations (AC: 5)
  - Log COST_CALCULATED action when calculation is performed
  - Include session_id, service_type, calculated_amount in audit details
  - Never log discount codes or PHI in audit logs
  - Add audit log verification in tests

- Task 8: Documentation and Admin Configuration (AC: 4, 5)
  - Document rate structure and calculation formula in code comments
  - Document how to add new service types and rate tiers
  - Document discount code format and validation rules
  - Add example calculation scenarios in documentation
  - Consider admin GraphQL mutation for rate management (defer to post-MVP if needed)
    </tasks>
  </story>

  <acceptanceCriteria>
1. Given session type and payer information, When cost calculation is requested, Then base rate is configurable per session type (intake, individual, family)

2. Given base rate, When calculation is performed, Then modifiers are applied for: session duration, therapist tier, special services

3. Given all factors, When calculation completes, Then returns: gross cost, adjustments array, net cost

4. Given cost calculation engine, When rates need updating, Then calculation is deterministic and auditable

5. Given cost calculation, When breakdown is stored, Then rates are easily configurable via admin
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/prd.md</path>
        <title>Product Requirements Document</title>
        <section>Epic 6: Cost Estimation Tool (P1)</section>
        <snippet>Provide parents with transparent, detailed cost information including insurance estimates, self-pay rates, deductible tracking, and payment options. User Value: Parents understand their financial responsibility upfront, reducing surprise bills and increasing trust.</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown</title>
        <section>Epic 6: Cost Estimation Tool - Story 6.1</section>
        <snippet>Story 6.1: Cost Calculation Engine. Flexible engine to calculate therapy session costs with base rates configurable per session type (intake, individual, family), modifiers for session duration, therapist tier, special services, tax calculations if applicable, and discount application (promotional, hardship). Returns gross cost, adjustments array, net cost. Calculation is deterministic and auditable, rates easily configurable via admin.</snippet>
      </doc>
      <doc>
        <path>docs/test-cases/contracts.csv</path>
        <title>Service Pricing Terms Test Data</title>
        <section>Contract Structure</section>
        <snippet>CSV contains contract data with fields: id, effective_date, end_date, services (JSON array), terms (JSON object). Services include: onsite_care, family_therapy, individual_therapy, google_meets, guardian_referral, self_referral, staff_referral. Terms contain pricing rules organized by kind: onsite, sponsored, support with cap_per_patient, pre_cap_collection_rule, post_cap_collection_rule, client_coverage_allowed, and other business rules.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Service Pattern</section>
        <snippet>Business logic services inherit from BaseService with class method call(*args) that instantiates and invokes instance method call. Services encapsulate business logic separate from models and controllers. Example: CostCalculationService in app/services/billing/ for cost computation logic.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Data Architecture</section>
        <snippet>PostgreSQL 16 with JSONB support for flexible schema fields. Models use Active Record with proper associations, validations, and enums. Migrations follow Rails conventions with timestamps and UUID primary keys. Indexes on frequently queried fields for performance.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>app/services/base_service.rb</path>
        <kind>service</kind>
        <symbol>BaseService</symbol>
        <lines>1-18</lines>
        <reason>Base service class that CostCalculationService should inherit from. Provides class method call pattern for service invocation.</reason>
      </artifact>
      <artifact>
        <path>app/models/onboarding_session.rb</path>
        <kind>model</kind>
        <symbol>OnboardingSession</symbol>
        <lines>1-160</lines>
        <reason>OnboardingSession model where cost estimates may be stored. Has associations to parent, child, insurance. Uses progress JSONB field pattern that can be extended with cost_estimate data.</reason>
      </artifact>
      <artifact>
        <path>app/models/insurance.rb</path>
        <kind>model</kind>
        <symbol>Insurance</symbol>
        <lines>1-430</lines>
        <reason>Insurance model with coverage details (copay, deductible, coinsurance) stored in verification_result JSONB field. Cost calculation will need to reference insurance coverage data from eligibility verification.</reason>
      </artifact>
      <artifact>
        <path>app/services/eligibility/base_adapter.rb</path>
        <kind>service</kind>
        <symbol>Eligibility::BaseAdapter</symbol>
        <lines>1-190</lines>
        <reason>Example of well-structured service with helper methods for building standardized data structures. Shows pattern for build_coverage, build_copay, build_deductible methods that can inform cost calculation breakdown structure.</reason>
      </artifact>
      <artifact>
        <path>app/models/concerns/encryptable.rb</path>
        <kind>concern</kind>
        <symbol>Encryptable</symbol>
        <lines>1-13</lines>
        <reason>PHI encryption concern. While cost data is generally not PHI, discount codes or hardship adjustments may contain sensitive information requiring encryption.</reason>
      </artifact>
      <artifact>
        <path>app/models/concerns/auditable.rb</path>
        <kind>concern</kind>
        <symbol>Auditable</symbol>
        <lines>1-20</lines>
        <reason>Audit logging concern for tracking cost calculations. All cost calculations should be audited for compliance and transparency.</reason>
      </artifact>
    </code>
    <dependencies>
      <ruby>
        <version>3.3.x</version>
        <gem name="rails" version="~> 7.2.3">Rails 7 API framework with Active Record and JSONB support</gem>
        <gem name="graphql" version="~> 2.2">GraphQL server for cost calculation queries</gem>
        <gem name="rspec-rails" version="~> 6.1">Testing framework</gem>
        <gem name="factory_bot_rails" version="~> 6.4">Test fixtures</gem>
        <gem name="money-rails" version="~> 1.15">Optional: Currency and money handling gem for precise decimal calculations</gem>
      </ruby>
      <environment>
        <var name="TAX_RATE">Optional: Sales tax rate if applicable for cost calculations (e.g., 0.0725 for 7.25%)</var>
        <var name="DEFAULT_SESSION_DURATION">Default session duration in minutes (e.g., 50)</var>
      </environment>
      <test_data>
        <file path="docs/test-cases/contracts.csv">Service pricing terms with effective dates, service types, and billing rules</file>
      </test_data>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Decimal Precision: All monetary amounts MUST use decimal type with 2 decimal places precision</constraint>
    <constraint>Base Rate Lookup: MUST query SessionRate model for current rate based on service_type and effective_date range</constraint>
    <constraint>Modifiers: MUST support duration modifiers (prorated), therapist tier modifiers, and special service fees</constraint>
    <constraint>Tax Calculation: MUST support optional tax calculation based on jurisdiction (configurable tax rate)</constraint>
    <constraint>Discount Application: MUST support discount codes and hardship adjustments with validation</constraint>
    <constraint>Breakdown Structure: MUST return structured breakdown with gross_cost, adjustments array (type, description, amount), net_cost</constraint>
    <constraint>Deterministic: Calculations MUST be deterministic (same inputs always produce same output)</constraint>
    <constraint>Auditable: All calculations MUST be logged via Auditable concern with COST_CALCULATED action</constraint>
    <constraint>Transparency: Breakdown MUST be stored for historical reference and dispute resolution</constraint>
    <constraint>Configuration: Rates MUST be easily updatable via SessionRate model (admin UI deferred to post-MVP)</constraint>
    <constraint>Test Data: MUST use docs/test-cases/contracts.csv for seeding service pricing terms</constraint>
    <constraint>Error Handling: MUST gracefully handle missing rates with clear error messages</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>Billing::CostCalculationService#call</name>
      <kind>service_method</kind>
      <signature>call(service_type:, duration: nil, therapist_tier: nil, special_services: [], discount_code: nil) -> Hash</signature>
      <path>app/services/billing/cost_calculation_service.rb</path>
      <description>Main cost calculation method. Accepts service type (enum: intake, individual_therapy, family_therapy), optional duration in minutes, optional therapist tier, optional special services array, optional discount code. Returns hash with gross_cost, adjustments array, net_cost, breakdown metadata.</description>
    </interface>
    <interface>
      <name>SessionRate</name>
      <kind>model</kind>
      <signature>service_type:string, base_rate:decimal, effective_date:date, end_date:date</signature>
      <path>app/models/session_rate.rb</path>
      <description>Active Record model for configurable session rates. Stores base rates per service type with effective date ranges. Supports querying current rate for given service type and date.</description>
    </interface>
    <interface>
      <name>SessionRate.current_rate_for</name>
      <kind>class_method</kind>
      <signature>current_rate_for(service_type:, date: Date.current) -> SessionRate</signature>
      <path>app/models/session_rate.rb</path>
      <description>Class method to query current active rate for given service type and date. Filters by effective_date range.</description>
    </interface>
    <interface>
      <name>Queries::CalculateCost</name>
      <kind>graphql_query</kind>
      <signature>calculateCost(sessionId: ID!, serviceType: ServiceTypeEnum!, duration: Int, discountCode: String): CostBreakdown!</signature>
      <path>app/graphql/queries/calculate_cost.rb</path>
      <description>GraphQL query for calculating therapy session costs. Requires session ID for authorization, service type, optional duration and discount code. Returns detailed cost breakdown.</description>
    </interface>
    <interface>
      <name>Types::CostBreakdownType</name>
      <kind>graphql_type</kind>
      <signature>grossCost, netCost, adjustments, calculatedAt, currency</signature>
      <path>app/graphql/types/cost_breakdown_type.rb</path>
      <description>GraphQL type for cost calculation breakdown. Exposes gross cost, net cost, array of adjustments, calculation timestamp, and currency code.</description>
    </interface>
    <interface>
      <name>Types::CostAdjustmentType</name>
      <kind>graphql_type</kind>
      <signature>type, description, amount, percentage</signature>
      <path>app/graphql/types/cost_adjustment_type.rb</path>
      <description>GraphQL type for individual cost adjustments. Type indicates adjustment category (duration_modifier, therapist_tier, tax, discount). Description is human-readable. Amount is dollar value, percentage is optional for percentage-based adjustments.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Rails project uses RSpec for testing with Factory Bot for fixtures and Shoulda Matchers for model testing. Test structure follows Rails conventions with spec/models/, spec/services/, spec/graphql/ directories. All monetary calculations must use precise decimal arithmetic (avoid floating point). Test with realistic service rates from contracts.csv seed data. Verify calculations are deterministic (same inputs yield same outputs). Test edge cases: zero discounts, 100% discounts, missing rates, invalid service types. Verify audit logging creates COST_CALCULATED entries without logging sensitive discount codes. Integration tests required for full GraphQL query flow. Test coverage target: 90%+ for all calculation logic.
    </standards>
    <locations>
      <location>spec/models/session_rate_spec.rb</location>
      <location>spec/factories/session_rates.rb</location>
      <location>spec/services/billing/cost_calculation_service_spec.rb</location>
      <location>spec/graphql/queries/calculate_cost_spec.rb</location>
      <location>spec/graphql/types/cost_breakdown_type_spec.rb</location>
      <location>spec/graphql/types/cost_adjustment_type_spec.rb</location>
      <location>db/seeds/service_rates.rb</location>
    </locations>
    <ideas>
      <idea acceptance_criteria="AC1">Test SessionRate model stores base rates per service type with effective date ranges</idea>
      <idea acceptance_criteria="AC1">Test SessionRate.current_rate_for returns correct rate for given service type and date</idea>
      <idea acceptance_criteria="AC2">Test CostCalculationService applies duration modifier (50 min session vs 90 min session)</idea>
      <idea acceptance_criteria="AC2">Test CostCalculationService applies therapist tier modifier (standard vs senior clinician)</idea>
      <idea acceptance_criteria="AC2">Test CostCalculationService applies special service fees (telehealth vs in-person)</idea>
      <idea acceptance_criteria="AC2">Test CostCalculationService calculates tax correctly based on configured rate</idea>
      <idea acceptance_criteria="AC2">Test CostCalculationService applies discount codes with percentage or fixed amount</idea>
      <idea acceptance_criteria="AC3">Test breakdown structure contains gross_cost, adjustments array with type/description/amount, net_cost</idea>
      <idea acceptance_criteria="AC3">Test adjustments array includes all applied modifiers with clear descriptions</idea>
      <idea acceptance_criteria="AC4">Test calculation is deterministic (multiple calls with same inputs return same result)</idea>
      <idea acceptance_criteria="AC4">Test calculation handles missing rates gracefully with error message</idea>
      <idea acceptance_criteria="AC5">Test breakdown is stored with timestamp and can be retrieved for audit</idea>
      <idea acceptance_criteria="AC5">Test audit log creates COST_CALCULATED entry with session_id and calculated_amount</idea>
      <idea>Test GraphQL query authorization (only session owner or admin can calculate costs)</idea>
      <idea>Test seed task successfully loads service rates from contracts.csv</idea>
      <idea>Test edge case: 100% discount results in zero net cost</idea>
      <idea>Test edge case: invalid service type returns validation error</idea>
      <idea>Integration test: full cost calculation query flow from GraphQL to service to model</idea>
    </ideas>
  </tests>

  <technical_notes>
    <note>
      <title>Contracts.csv Data Structure</title>
      <content>The contracts.csv file contains service pricing terms in a nested JSON structure. The "services" field is a JSON array of service types (e.g., ["individual_therapy", "family_therapy"]). The "terms" field is a JSON object with three categories: "onsite" (onsite_care), "sponsored" (family_therapy, individual_therapy with billing rules), and "support" (referral services). The sponsored terms include cap_per_patient, collection rules, and coverage options that inform pricing strategy. For Story 6.1, focus on extracting service types and mapping them to base rates. More complex billing rules (caps, coverage) will be addressed in Story 6.2 (Insurance Cost Estimation).</content>
    </note>
    <note>
      <title>Service Type Enumeration</title>
      <content>Based on contracts.csv, core service types for therapy sessions are: "individual_therapy" (1:1 child-therapist), "family_therapy" (parent + child with therapist), "onsite_care" (school-based services). Additional service types in CSV (google_meets, guardian_referral, etc.) are support services that may not have direct session costs. Define service_type enum in SessionRate model to match these categories.</content>
    </note>
    <note>
      <title>Decimal Precision and Money Handling</title>
      <content>Use Rails decimal type with precision: 10, scale: 2 for all monetary amounts to avoid floating point arithmetic errors. Consider using money-rails gem for currency handling if calculations become complex. All calculations should round to 2 decimal places using BigDecimal for precision.</content>
    </note>
    <note>
      <title>Rate Versioning Strategy</title>
      <content>SessionRate model uses effective_date and end_date to support rate changes over time. When creating new rates, set end_date of previous rate to day before new rate's effective_date. Query current_rate_for uses Date.current by default but accepts optional date parameter for historical calculations or future estimates.</content>
    </note>
    <note>
      <title>Discount Code Validation</title>
      <content>Discount codes may contain PHI or sensitive information (e.g., hardship codes). Consider encrypting discount_code field if stored. For Story 6.1, implement basic percentage or fixed-amount discounts. More complex discount logic (eligibility rules, expiration) can be deferred to Story 6.5 (Payment Plan Options).</content>
    </note>
    <note>
      <title>Tax Calculation</title>
      <content>Tax calculation should be configurable via environment variable or admin setting. Some jurisdictions don't tax healthcare services. Implement tax as optional adjustment applied after base rate and modifiers but before discounts. Tax rate should be percentage (e.g., 0.0725 for 7.25%).</content>
    </note>
    <note>
      <title>Integration with Epic 4 Insurance Data</title>
      <content>Story 6.1 focuses on base cost calculation without insurance. Story 6.2 (Insurance Cost Estimation) will integrate with Insurance model's verification_result data (copay, deductible, coinsurance) to calculate patient responsibility. The CostCalculationService should be designed to accept optional insurance_coverage parameter for future extensibility.</content>
    </note>
  </technical_notes>
</story-context>
